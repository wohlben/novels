{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{chapter.fiction.title }}: {{ chapter.title }}</title>
    <link rel="stylesheet" href="{% static 'font-awesome/css/font-awesome.min.css' %}">
    {% if user.is_authenticated %}
      <link rel="stylesheet" href="{% static 'bootswatch/dist' %}/{{ user.color_theme }}/bootstrap.css" >
    {% else %}
      <link rel="stylesheet" href="{% static 'bootswatch/dist/darkly/bootstrap.css' %}">
    {% endif %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/chapter.css' %}">
    <script src="{% static "jquery/dist/jquery.min.js" %}"></script>
    <script src="{% static "js-cookie/src/js.cookie.js" %}"></script>
    <script src="{% static "bootstrap/dist/js/bootstrap.bundle.min.js" %}"></script>
    <script src="{% static "intercooler/dist/intercooler.js" %}"></script>
    <script src="{% static "js/base.js" %}"></script>
    <script src="{% static "js/chapter.js" %}"></script>
</head>
<body>
    <nav class="navbar fixed-top navbar-expand-md navbar-light bg-light">
        <button class="nav-item btn btn-dark"
                    {% if progress.progress != 0 %}
                    title="continue to progress saved on server"
                    {% else %}
                    title="progress saved on server"
                    {% endif %}
                    onclick="scrollToPercentage({{ progress.progress }})">
                <i class="fa fa-cloud-download"></i>
                <span id="server-progress">{{ progress }}</span>
        </button>
        <button class="btn btn-dark nav-item"
                    title="upload current progress to server"
                    onclick="submitScrollPosition()">
                <i class="fa fa-cloud-upload"></i>
                <span id="client-progress">0 %</span>
        </button>
        <div class="dropdown">
            <button class="btn btn-dark nav-link dropdown-toggle" href="#" id="linkDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fa fa-link fa-lg"></i> </button>
            <div class="dropdown-menu" aria-labelledby="linkDropdown">
                {% if perms.scrapes.view_system %}
                <a class="dropdown-item" title="force a refetch on the server" ic-confirm="refetch this chapter?" ic-post-to="/api/chapters/{{ chapter.id }}/requeue/">
                    <i class="fa fa-refresh"></i>
                    Refetch
                </a>
                <div class="dropdown-divider"></div>
                {% endif %}
                <a class="dropdown-item" title="go to fiction" href="{{ chapter.fiction.get_absolute_url }}">
                    <i class="fa fa-book fa-lg"></i>
                    {{ chapter.fiction.title }}
                </a>
                <div class="dropdown-divider"></div>
                {% if chapter.get_previous_chapter %}
                    <a class="dropdown-item" title="go to last chapter" href="{{ chapter.get_previous_chapter.get_absolute_url }}"><i class="fa fa-arrow-left fa-lg">last chapter</i></a>
                {% endif %}
                {% if chapter.get_next_chapter %}
                    <a class="dropdown-item" title="go to next chapter" href="{{ chapter.get_next_chapter.get_absolute_url }}"><i class="fa fa-arrow-right fa-lg">next chapter</i></button>
                {% endif %}
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" title="go to latest chapters" href="{% url "novels:updates" %}?watching=true">
                    <i class="fa fa-leanpub"></i>
                    latest chapters
                </a>
                <div class="dropdown-divider"></div>
                <button class="btn btn-dark" title="decrease text size" onclick="resizeText(false)">
                    <i class="fa fa-minus-square-o fa-lg"></i>
                    increase text
                </button>
                <button class="btn btn-dark" title="increase text size" onclick="resizeText(true)">
                    <i class="fa fa-plus-square-o fa-lg"></i>
                    decrease text
                </button>
            </div>
        </div>
    </nav>


    <h6 class="text-center pt-1"><span title="fiction title">{{ chapter.fiction.title }}</span> by <span title="author name">{{ chapter.fiction.author }}</span></h6>
    <h2 class="text-center" title="chapter title">{{ chapter.title }}</h2>
    <p class="text-muted text-center">
        last fetch: <time title="time of the last fetch">{{ chapter.updated }}</time><br/>
        published: <time title="date this chapter was published on the source">{{ chapter.published }}</time><br/>
        {% if following_chapters > 0 %}
        There are still {{ following_chapters }} unread chapters before you <i class="fa fa-smile-o"></i>
        {% endif %}

    </p>
    {% if chapter.content is not None %}
        <div ic-replace-target="true"
             ic-get-from="{% url "profiles:bulk-reading-progress" chapter_id=chapter.id %}"
             ic-trigger-on="load"></div>
    {% endif %}

    <hr />
    {% if chapter.content is None %}
    <p class="jumbotron text-center">
        this chapter hasn't been fetched yet
    {% if perms.scrapes.force_fetch %}
      , but you do have permission to <a href="{{ chapter.get_absolute_url }}?force-fetch=true">force a fetch</a>
    {% else %}
      and you don't have the permission to force a fetch
    {% endif %}
      <br />
        You could always go to the original source, which you probably
        should've done to begin with...
      <br/>
        cheers mate
      <br />
      <a href="{{ chapter.url }}">source</a>
      <br />
        the scrape queue is currently ... {{ scrape_queue_count }} items long. <br />
        waiting is probably not worth it!

    </p>
    {% else %}
    <div id="chapter-content" class="pl-3 pr-3">
        {{ chapter.content|safe  }}
    </div>
    {% endif %}

    <hr />

<aside class="d-flex justify-content-center btn-group">
    {% if chapter.get_previous_chapter %}
    <a title="go to the previous chapter"
       href="{{ chapter.get_previous_chapter.get_absolute_url }}"><button class="btn btn-primary">Last Chapter</button></a>
    {% else %}
    <button title="there is no previous chapter" class="btn btn-light">Last Chapter</button>
    {% endif %}
    <a href="{{ chapter.url }}"><button class="btn btn-link">source</button> </a>
    {% if chapter.get_next_chapter %}
    <a title="go to the next chapter"
       href="{{ chapter.get_next_chapter.get_absolute_url }}">
        <button class="btn btn-primary">Next Chapter</button>
    </a>
    {% else %}
    <button title="there is no next chapter" class="btn btn-light">Next Chapter</button>
    {% endif %}
</aside>
{% if user.is_authenticated %}
<script>
    $(document).ready( () => {
        resetTextSize();
        window.progress_id = {{ progress.id }};
        window.chapter_id = {{ chapter.id }};
        window.last_position = {{ progress.progress }};
        window.current_position = getScrollPercentage();
        $('#client-progress').text(window.current_position + ' %');

        let timeout = null;

        $(window).scroll(() => {
            if (!timeout) {
                timeout = setTimeout(() => {
                    clearTimeout(timeout);
                    timeout = null;
                    let position = getScrollPercentage();

                    if (position !== window.current_position){
                        window.current_position = position;
                        $('#client-progress').text(window.current_position + ' %');
                    }
                    if (position % 20 === 0 || window.last_position + 20 < position) {
                        window.last_position = position;
                        submitScrollPosition();
                    }
                }, 1000);
            }
        });
    });
</script>
{% endif %}
</body>
</html>
