{% extends "base.html" %}
{% load static %}
{% load read_inserter %}
{% block title %}{{chapter.fiction.title }}: {{ chapter.title }}{% endblock %}
{% block content %}
    <h6 class="text-center pt-1"><span title="fiction title">{{ chapter.fiction.title }}</span> by <span title="author name">{{ chapter.fiction.author }}</span></h6>
<h2 class="text-center" title="chapter title">{{ chapter.title }}</h2>
<p class="text-muted text-center">
    last fetch: <time title="time of the last fetch">{{ chapter.updated }}</time><br/>
    published: <time title="date this chapter was published on the source">{{ chapter.published }}</time><br/>
    {% if following_chapters > 0 %}
    There are still {{ following_chapters }} unread chapters before you :)
    {% endif %}

</p>
<aside class="d-flex justify-content-center text-center">
    <span title="refetch the chapter"
          id="requeue-component"
          ic-replace-target="true"
          ic-src="{% url "scrapes:requeue-chapter" chapter_id=chapter.id %}"
          ic-trigger-on="load"></span>
    <button class="btn btn-light" title="increase Text size" onclick="resizeText(true)">
        increase
    </button>
    <button class="btn btn-light" title="decrease Text size" onclick="resizeText(false)">
       decrease
    </button>
    <a title="go back to the fiction overview" href="{{ chapter.fiction.get_absolute_url }}"><button class="btn btn-light">Fiction overview</button> </a>
    {% if progress == None %}
    {% elif progress.progress == 100 %}
            <div id="progress-{{ chapter.total_progress }}" ic-get-from=" ic-trigger-on="scrolled-into-view"></div>
            <button title="reset progress" class="btn btn-primary"
                    ic-get-from="{% url "profiles:reading-progress" chapter_id=chapter.id progress=0 %}"
                    ic-replace-target="true"
            >start over</button>
    {% else %}
        <a title="go to the last progress event"
           onclick="scrollToPercentage({{ progress.progress }})">
            <button class="btn button btn-light">continue</button>
        </a>
    {% endif %}

</aside>
    {% if chapter.content is not None %}
        <div ic-replace-target="true"
             ic-get-from="{% url "profiles:bulk-reading-progress" chapter_id=chapter.id %}"
             ic-trigger-on="load"></div>
    {% endif %}

<hr />
    {% if chapter.content is None %}
    <p class="jumbotron text-center">
        this chapter hasn't been fetched yet
    {% if perms.scrapes.force_fetch %}
      , but you do have permission to <a href="{{ chapter.get_absolute_url }}?force-fetch=true">force a fetch</a>
    {% else %}
      and you don't have the permission to force a fetch
    {% endif %}
      <br />
        You could always go to the original source, which you probably
        should've done to begin with...
      <br/>
        cheers mate
      <br />
      <a href="{{ chapter.url }}">source</a>
      <br />
        the scrape queue is currently ... {{ scrape_queue_count }} items long. <br />
        waiting is probably not worth it!

    </p>
    {% else %}
    <div id="chapter-content" class="pl-3 pr-3">
        {{ chapter.content|safe  }}
    </div>
    <div id="progress-{{ chapter.total_progress }}" ic-get-from="{% url "profiles:reading-progress" chapter_id=chapter.id progress=chapter.total_progress %}" ic-trigger-on="scrolled-into-view"></div>
    {% endif %}
<hr />

<aside class="d-flex justify-content-center btn-group">
    {% if chapter.get_previous_chapter %}
    <a title="go to the previous chapter"
       href="{{ chapter.get_previous_chapter.get_absolute_url }}"><button class="btn btn-primary">Last Chapter</button></a>
    {% else %}
    <button title="there is no previous chapter" class="btn btn-light">Last Chapter</button>
    {% endif %}
    <a href="{{ chapter.fiction.get_absolute_url }}"><button class="btn btn-link">Fiction overview</button> </a>
    <a href="{{ chapter.url }}"><button class="btn btn-link">source</button> </a>
    {% if chapter.get_next_chapter %}
    <a title="go to the next chapter"
       href="{{ chapter.get_next_chapter.get_absolute_url }}">
        <button class="btn btn-primary">Next Chapter</button>
    </a>
    {% else %}
    <button title="there is no next chapter" class="btn btn-light">Next Chapter</button>
    {% endif %}
</aside>
{% if user.is_authenticated %}
<script>
    $(document).ready( () => {
        resetTextSize();
        window.progress_id = {{ progress.id }};
        window.chapter_id = {{ chapter.id }};
        window.last_position = {{ progress.progress }};
        let timeout = null;

        $(window).scroll(() => {
            if (!timeout) {
                timeout = setTimeout(() => {
                    clearTimeout(timeout);
                    timeout = null;
                    let position = getScrollPercentage();
                    if (window.last_position + 1 < position) {
                        window.last_position = position;
                        submitScrollPosition();
                    }
                }, 2500);
            }
        });
    });
</script>
{% endif %}
{% endblock %}
